<style type="text/css">
main img {
  width: 50%;
  max-width: 100%;
}
main ul p, main ol p {
  display: block;
}
</style>

# 4. practice: Securing a Spring Boot application -- Web engineering

## Table of contents

1. Concepts
2. Configuration
3. Authentication flow
4. Custom login form
5. Database authentication

## Goals

- In the current state we can list, add, edit and delete entities (CRUD operations = Create, Read, Update, Delete).
- Make adding and editing available after logging in to the application.

## Securing a Spring Boot application

### Technology and concepts

We will use *Spring Security* for securing our application. It provides different types of authentication and authorization, but in this case we will use the so-called form login authentication method. It will show up a login form every time it is necessary to authenticate the user. After authentication the login information is saved into the session.

*Session* is a mechanism to store information per client on the server side. It is heavily uses cookies to store the so-called session id. On the first request the server initializes a new session described by a session id string. This string then is sent back to client, instructing the client to store the session id in a client-side cookie. This cookie is sent automatically every time the client sends a request. The server reads out the session id from the request headers, and makes available all the information belonging to that session to the server-side code.

*Session-based authentication* is nothing else just storing a special value in the session after a successful validation. This information indicates that the user has already validated himself/herself. Logging out needs to remove this information from the session.

*Authorization* is a process when it is decided whether an actual user can access a resource.

### Configuration

Add the following dependency to the `pom.xml`:

```java
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

You will also need a `WebSecurityConfig.java` configuration class, where we can affect the security processes with overriding some important methods. This file needs to be beside the main application class. The basic structure is:

```java
@Configuration
@EnableWebSecurity
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
    
    }    

    @Autowired
    protected void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {

    }

    @Bean
    public BCryptPasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

}
```

If we try our application, we can see it always redirects to the login page. The [default settings](https://docs.spring.io/spring-security/site/docs/4.2.3.RELEASE/reference/htmlsingle/#hello-web-security-java-configuration) will give a lot of security implications.

### Adding a default in-memory user

In this configuration class add the following to the `configureGlobal` method:

```java
@Autowired
protected void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
    auth
        .inMemoryAuthentication()
        .withUser("user").password("$2a$04$YDiv9c./ytEGZQopFfExoOgGlJL6/o0er0K.hiGb5TGKHUL8Ebn..").roles("USER"); // user/password
}
```

### Fine-tuning the security process

The [`HttpSecurity`](https://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/config/annotation/web/builders/HttpSecurity.html#formLogin--) class is responsible for specifying the security flow. The following are the default settings:

```java
@Override
protected void configure(HttpSecurity http) throws Exception {
    http
        .authorizeRequests()
            .anyRequest().authenticated()
            .and()
        .formLogin()
            .and()
        .httpBasic();
}
```

It means that requests are needed to be authorized ([authorizeRequests](https://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/config/annotation/web/builders/HttpSecurity.html#authorizeRequests--)), every request should be authenticated, and for that use the form login method, and if it is unavailable, use the in-built HTTP Basic authentication.

We can specify different rules for different endpoints using the `antMatchers()` method, as you can see in the following example:

```java
http
    .authorizeRequests()
        .antMatchers("/admin/**").hasRole("ADMIN")
        .antMatchers("/**").hasRole("USER");
```

In our case we would like to access the main listing page, and the others should be authenticated:

```java
http
    .authorizeRequests()
        .antMatchers("/").permitAll()
        .anyRequest().authenticated();
```

Try this and you will see an `Access denied` error for the secured endpoints!

### Form login

We can ask Spring security, that every time the access is denied, redirect the browser to the login form page:

```java
http
    .authorizeRequests()
        .antMatchers("/").permitAll()
        .anyRequest().authenticated();
        .and()
    .formLogin();
```

This registers the `/login` and `/logout` endpoints, and various other security settings. The behaviour of the form login method can be customized, e.g.:

```java
http.authorizeRequests().antMatchers("/**").hasRole("USER").and().formLogin()
    .usernameParameter("username") // default is username
    .passwordParameter("password") // default is password
    .loginPage("/authentication/login") // default is /login with an HTTP get
    .failureUrl("/authentication/login?failed") // default is /login?error
    .loginProcessingUrl("/authentication/login/process"); // default is /login
```

### Using a custom login form

If we set `formLogin().loginPage('/login')`, then:

- when authentication is required, redirect the browser to `/login`
- we are in charge of rendering the login page when `/login` is requested
- when authentication attempt fails, redirect the browser to `/login?error` (since we have not specified otherwise)
- we are in charge of rendering a failure page when `/login?error` is requested
- when we successfully logout, redirect the browser to `/login?logout` (since we have not specified otherwise)
- we are in charge of rendering a logout confirmation page when `/login?logout` is requested

So it is up to us, to declare a controller... 

```java
@GetMapping("/auth/login")
public String login() {
    return "login";
}
```

...and a view:

```html
<div th:if="${param.error}">
    Invalid username and password.
</div>
<div th:if="${param.logout}">
    You have been logged out.
</div>
<form th:action="@{/auth/login}" method="post">
    <div><label> User Name : <input type="text" name="username"/> </label></div>
    <div><label> Password: <input type="password" name="password"/> </label></div>
    <input
      type="hidden"
      th:name="${_csrf.parameterName}"
      th:value="${_csrf.token}" />
    <div><input type="submit" value="Sign In"/></div>
</form>
```

At the login form we need to add explicitly the CSRF tokent for the
[CSRF protection](http://www.baeldung.com/csrf-thymeleaf-with-spring-security).
Other forms (e.g. `/add`) will include it automatically.

### Logout

Add the following to the templates where it is necessary:

```html
<form th:action="@{/logout}" method="post">
    <input type="submit" value="Sign Out"/>
</form>
```

Customizing the logout process:

```java
http
    .logout()
        .logoutUrl("/my/logout")
        .logoutSuccessUrl("/my/index")
        .logoutSuccessHandler(logoutSuccessHandler)
        .invalidateHttpSession(true)
        .addLogoutHandler(logoutHandler)
        .deleteCookies(cookieNamesToClear)
```

### User informations

In the templates:

```html
<p th:text="${#httpServletRequest.remoteUser}">Győző</p>
```

Or you can use a [Thymeleaf extension](https://github.com/thymeleaf/thymeleaf-extras-springsecurity#features):

Add to `pom.xml`:

```xml
<dependency>
    <groupId>org.thymeleaf.extras</groupId>
    <artifactId>thymeleaf-extras-springsecurity4</artifactId>   
</dependency>
```

In the template:

```html
<div sec:authorize="isAuthenticated()">     
    Logged in user: <span sec:authentication="name">Győző</span> |
    Roles: <span sec:authentication="principal.authorities"></span>            
</div>
```

In the controllers:

```java
Authentication auth = SecurityContextHolder.getContext().getAuthentication();
String name = auth.getName(); //get logged in username

// or

// User = org.springframework.security.core.userdetails.User
User user = (User)SecurityContextHolder.getContext().getAuthentication().getPrincipal();
String name = user.getUsername(); //get logged in username
```

or injecting directly into our controller:

```java
public String something(Principal principal ) {
    String name = principal.getName(); //get logged in username
}
```

### Using H2 console

```java
http
    .authorizeRequests()
        .antMatchers("/", "/h2/**").permitAll()
        .anyRequest().authenticated()
        .and()
    .formLogin()
        .loginPage("/auth/login")
        .permitAll()
        .and()
    .csrf()         // important!
        .ignoringAntMatchers("/h2/**")
        .and()
    .headers()
        .frameOptions().disable();  // important!
```

### Authentication from database

There are many authentication techniques in `AuthenticationManagerBuilder`. One can use in-memory, JDBC, LDAP and UserDetailsService authentication.
We will use JPA for getting user information, and use UserDetailsService authentication in our configuration file.

Declare the `User` entity with username, password and role:

```java
@Entity
@Data
@NoArgsConstructor
@AllArgsConstructor
public class User {

    @Id
    @GeneratedValue(strategy = GenerationType.AUTO)
    private long id;
    
    @Column(nullable = false)
    private String username;
    
    @Column(nullable = false)
    private String password;
    
    @Column(nullable = false)
    private boolean enabled;
    
    @Column(nullable = false)
    @Enumerated(EnumType.STRING)
    private Role role;
    
    public enum Role {
        ROLE_GUEST, ROLE_USER, ROLE_ADMIN
    }
}
```

Seed the database with some user data:

```sql
insert into user (username, password, enabled, role) values ('admin', 'a', 1, 'ROLE_ADMIN');
insert into user (username, password, enabled, role) values ('user', 'u', 1, 'ROLE_USER'); 
```

Create a user repository with a `findByUsername` method:

```java
public interface UserRepository extends CrudRepository<User, Long> {
    User findByUsername(String username);
}
```

Create a UserDetailsService implementation:

```java
@Service
public class MyUserDetailsService implements UserDetailsService {

    @Autowired
    private UserRepository userRepository;

    @Override
    @Transactional(readOnly = true)
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        User user = userRepository.findByUsername(username);
        if (user == null) {
            throw new UsernameNotFoundException(username);
        }
        Set<GrantedAuthority> grantedAuthorities = new HashSet<>();
        grantedAuthorities.add(new SimpleGrantedAuthority(user.getRole().toString()));

        return new org.springframework.security.core.userdetails.User(user.getUsername(), user.getPassword(), grantedAuthorities);
    }
}
```

And finally in `WebSecurityConfig`:

```java
@Autowired
private UserDetailsService userDetailsService;

@Autowired
protected void configureAuthentication(AuthenticationManagerBuilder auth) throws Exception {
    auth.userDetailsService(userDetailsService);
}
```

### References

- [Spring Security reference](https://docs.spring.io/spring-security/site/docs/4.2.3.RELEASE/reference/htmlsingle/)
- [Spring Security architecture](https://spring.io/guides/topicals/spring-security-architecture/)
- [Spring Security basic tutorial](https://docs.spring.io/spring-security/site/docs/current/guides/html5//helloworld-boot.html)
- [Spring Security custom login form tutorial](https://docs.spring.io/spring-security/site/docs/current/guides/html5//form-javaconfig.html)
- [JPA authentication (with registration)](https://hellokoding.com/registration-and-login-example-with-spring-security-spring-boot-spring-data-jpa-hsql-jsp/)
- [JPA authentication (with customUserDetails)](http://www.programming-free.com/2016/01/spring-security-spring-data-jpa.html)
- [JPA authentication (another variation)](http://www.baeldung.com/spring-security-authentication-with-a-database)
